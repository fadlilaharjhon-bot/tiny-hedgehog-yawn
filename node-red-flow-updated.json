[
    {
        "id": "a1b2c3d4e5f6g7h8",
        "type": "tab",
        "label": "Kontrol Lampu Terintegrasi (LDR + Gestur)",
        "disabled": false,
        "info": "Flow ini mengintegrasikan kontrol lampu dari ESP8266 (Serial), Dashboard React (MQTT), dan Kontrol Gestur Python (HTTP)."
    },
    {
        "id": "serial-in-esp",
        "type": "serial in",
        "z": "a1b2c3d4e5f6g7h8",
        "name": "ESP8266 Serial In",
        "serial": "c9d1b2f3a1d0e4b5",
        "x": 150,
        "y": 200,
        "wires": [
            [
                "json-parser-esp"
            ]
        ]
    },
    {
        "id": "json-parser-esp",
        "type": "json",
        "z": "a1b2c3d4e5f6g7h8",
        "name": "Parse JSON from ESP",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 370,
        "y": 200,
        "wires": [
            [
                "mqtt-out-ldr-status"
            ]
        ]
    },
    {
        "id": "mqtt-out-ldr-status",
        "type": "mqtt out",
        "z": "a1b2c3d4e5f6g7h8",
        "name": "MQTT Out: LDR Status",
        "topic": "POLINES/FADLI/IL",
        "qos": "1",
        "retain": "true",
        "broker": "90a08a8a9b3870d2",
        "x": 610,
        "y": 200,
        "wires": []
    },
    {
        "id": "serial-out-esp",
        "type": "serial out",
        "z": "a1b2c3d4e5f6g7h8",
        "name": "ESP8266 Serial Out",
        "serial": "c9d1b2f3a1d0e4b5",
        "x": 870,
        "y": 440,
        "wires": []
    },
    {
        "id": "mqtt-in-ldr-command",
        "type": "mqtt in",
        "z": "a1b2c3d4e5f6g7h8",
        "name": "MQTT In: LDR Command",
        "topic": "POLINES/PADLI/IL",
        "qos": "2",
        "datatype": "json",
        "broker": "90a08a8a9b3870d2",
        "x": 160,
        "y": 440,
        "wires": [
            [
                "command-aggregator"
            ]
        ]
    },
    {
        "id": "mqtt-in-ldr-threshold",
        "type": "mqtt in",
        "z": "a1b2c3d4e5f6g7h8",
        "name": "MQTT In: LDR Threshold",
        "topic": "POLINES/BADLI/IL",
        "qos": "2",
        "datatype": "json",
        "broker": "90a08a8a9b3870d2",
        "x": 160,
        "y": 500,
        "wires": [
            [
                "command-aggregator"
            ]
        ]
    },
    {
        "id": "mqtt-in-room-command",
        "type": "mqtt in",
        "z": "a1b2c3d4e5f6g7h8",
        "name": "MQTT In: Room Lamp Command",
        "topic": "POLINES/LAMPU_RUANG/COMMAND",
        "qos": "2",
        "datatype": "json",
        "broker": "90a08a8a9b3870d2",
        "x": 190,
        "y": 560,
        "wires": [
            [
                "command-aggregator"
            ]
        ]
    },
    {
        "id": "command-aggregator",
        "type": "function",
        "z": "a1b2c3d4e5f6g7h8",
        "name": "Process & Route Commands",
        "func": "let cmd = msg.payload;\nlet out = {};\n\n// Dari MQTT LDR Dashboard (Topik: POLINES/PADLI/IL & POLINES/BADLI/IL)\nif (cmd.mode) out.mode = cmd.mode;\nif (cmd.led === 'toggle') out.led = 'toggle'; // Untuk kontrol manual lampu teras\nif (cmd.threshold) out.threshold = cmd.threshold; // Ini nilai 0-1023\n\n// Dari MQTT Room Lamp Dashboard / Gestur (Topik: POLINES/LAMPU_RUANG/COMMAND)\nif (cmd.hasOwnProperty('toggle_lamp1')) out.toggle_lamp1 = true;\nif (cmd.hasOwnProperty('toggle_lamp2')) out.toggle_lamp2 = true;\n\n// Hanya kirim jika ada perintah yang valid\nif (Object.keys(out).length > 0) {\n    // Tambahkan newline agar mudah dibaca oleh Arduino `readStringUntil('\\n')`\n    msg.payload = JSON.stringify(out) + '\\n';\n    return msg;\n}\n\nreturn null; // Hentikan flow jika tidak ada perintah yang relevan",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 590,
        "y": 440,
        "wires": [
            [
                "serial-out-esp"
            ]
        ]
    },
    {
        "id": "c9d1b2f3a1d0e4b5",
        "type": "serial-port",
        "name": "",
        "serialport": "COM12",
        "serialbaud": "9600",
        "databits": "8",
        "parity": "none",
        "stopbits": "1",
        "waitfor": "",
        "newline": "\\n",
        "bin": "false",
        "out": "char",
        "addchar": "",
        "responsetimeout": "10000"
    },
    {
        "id": "90a08a8a9b3870d2",
        "type": "mqtt-broker",
        "name": "broker.hivemq.com",
        "broker": "broker.hivemq.com",
        "port": "1883",
        "clientid": "",
        "autoConnect": true,
        "usetls": false,
        "protocolVersion": "4",
        "keepalive": "60",
        "cleansession": true,
        "autoUnsubscribe": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthRetain": "false",
        "birthPayload": "",
        "birthMsg": {},
        "closeTopic": "",
        "closeQos": "0",
        "closeRetain": "false",
        "closePayload": "",
        "closeMsg": {},
        "willTopic": "",
        "willQos": "0",
        "willRetain": "false",
        "willPayload": "",
        "willMsg": {},
        "userProps": "",
        "sessionExpiry": ""
    }
]